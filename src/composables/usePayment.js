import { useAuth } from "./useAuth.js";

const { api, updateAuth } = useAuth();

export function usePayment() {
    const topUp = async (card_id, amount, typ, details, clerk) => {
        // Ensure client is authenticated before making the API call
        const topUpBody = {
            timestamp: 0, // is generated by the server
            card_id: card_id,
            amount: amount,
            bill_nr: "", // is generated by the server
            paypal_details: details,
            typ: typ,
            clerk: clerk,
        };
        return new Promise((resolve, reject) => {
            api.topupCredit(topUpBody, (error, data) => {
                if (error) {
                    reject(error)
                } else {
                    resolve(data);
                }
            });
        })
    };

    const payment = async (card_id, name, amount, id, dryTime, typ, details) => {
        if (card_id=='anonym'){
            updateAuth(null);
        } else {
            updateAuth(card_id);
        }
        if (dryTime){
            amount=amount*(dryTime/10) // FIXME hardcoded time 10 minutes per price unit
        }
        const paymentBody = {
            card_id: card_id,
            machine_name: name,
            machine_id: id,
            amount: amount,
            bill_nr: "", // is generated by the server
            typ: typ,
            paypal_details: details,
        };
        return new Promise((resolve, reject) => {
            api.payment(paymentBody, (error, data) => {
                if (error) {
                    reject(error)
                } else {
                    resolve(data);
                }
            });
        })
    }

    const payments = async (card_id, from, to) => {
        updateAuth(card_id);
        return new Promise((resolve, reject) => {
            var opts = {
                from: from,
                to: to,
            }
            api.getUserPayments(card_id, opts, (error, data) => {
                if (error) {
                    reject(error)
                } else {
                    resolve(data);
                }
            })
        })
    }

    const allowStart = (name, duration) => {
        api.allowStart(name, duration,
            (error, data, response) => {
                if (error) {
                    console.error(error);
                    return;
                } 
                console.log("allowStart", response);
            }
        );
    };

    return {
        topUp,
        allowStart,
        payment,
        payments,
    };
}